###############################
# Foederati events
#
# Written by Loup
#
# WtWSMS_foederati.1 -> WtWSMS_foederati.31
###############################

namespace = WtWSMS_foederati

###############################
# Foederati negotiations
###############################

# Romans accept or refuse to start negotiating with barbarian
long_character_event = {
	id = WtWSMS_foederati.1
	desc = WtWSMS_foederati.1.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		FROMFROM = {
			save_event_target_as = barbarian_negotiator
		}
		ROOT = {
			save_event_target_as = roman_negotiator
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati Negotiations between [FromFrom.GetTitledName] and [Root.GetTitledName] started."
	}
	
	option = { # Yes
		name = WtWSMS_foederati.1.a
		ai_chance = {
			# AI should generally accept
			factor = 75
			modifier = {
				factor = 1.5
				event_target:barbarian_negotiator = {
					religion = event_target:roman_negotiator
				}
			}
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = trusting
				}
			}
			modifier = {
				factor = 1.5
				event_target:roman_negotiator = {
					trait = grey_eminence
				}
			}
			modifier = {
				factor = 0.5
				event_target:barbarian_negotiator = {
					realm_size < 50
				}
			}
			modifier = {
				factor = 0.5
				event_target:barbarian_negotiator = {
					lower_tier_than = emperor
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.1.a.tooltip # Negotiations begin
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.2 # Negotiations begin - settle in empire or not?
				days = 7
				random = 3
			}
		}
	}
	option = { # No, negotiations break
		name = WtWSMS_foederati.1.b
		ai_chance = {
			# In case the Barbarian is menacing or otherwise too hostile
			factor = 25
			modifier = {
				factor = 1.25
				event_target:barbarian_negotiator = {
					trait = cruel
				}
			}
			modifier = {
				factor = 1.25
				event_target:barbarian_negotiator = {
					trait = impaler
				}
			}
			modifier = {
				factor = 1.25
				event_target:barbarian_negotiator = {
					trait = zealous
					NOT = { religion = event_target:roman_negotiator }
				}
			}
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = zealous
				}
				event_target:barbarian_negotiator = {
					NOT = { religion = event_target:roman_negotiator }
				}
			}
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = paranoid
				}
			}
			modifier = {
				factor = 2
				event_target:barbarian_negotiator = {
					infamy = 50
				}
			}
			modifier = {
				factor = 2
				event_target:roman_negotiator = {
					event_target:barbarian_negotiator = {
						relative_realm_size = {
							who = PREV
							size = 1
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.1.b.tooltip # Negotiations do not start, risk of war
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
				days = 7
				random = 3
			}
		}
	}
}

# Negotiations begin - settle in empire or not?
long_character_event = {
	id = WtWSMS_foederati.2
	desc = WtWSMS_foederati.2.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Yes
		name = WtWSMS_foederati.2.a
		ai_chance = {
			# Feeling threatened
			factor = 75
			modifier = {
				factor = 2
				event_target:barbarian_negotiator = {
					any_neighbor_independent_ruler = {
						relative_realm_size = {
							who = PREV
							size = 2
						}
					}
				}
			}
			modifier = {
				factor = 2
				event_target:barbarian_negotiator = {
					any_neighbor_independent_ruler = {
						infamy = 50
					}
				}
			}
			modifier = {
				factor = 2
				event_target:barbarian_negotiator = {
					any_neighbor_independent_ruler = {
						relative_power_including_allies_attacker = {
							who = PREV
							power = 2
						}
					}
				}
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.3 # Barbarian negotiator wishes to settle in the empire
				days = 7
				random = 3
			}
		}
	}
	option = { # No
		name = WtWSMS_foederati.2.b
		ai_chance = {
			factor = 25
			# More likely if the Romans are approaching
			modifier = {
				factor = 2
				event_target:roman_negotiator = {
					has_character_flag = roman_initiated_negotiations
				}
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.11 # Barbarian negotiator does not wish to settle in the empire
				days = 7
				random = 3
			}
		}
	}
}

# Barbarian negotiator wishes to settle in the empire
long_character_event = {
	id = WtWSMS_foederati.3
	desc = WtWSMS_foederati.3.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Accept it and offer a territory
		name = WtWSMS_foederati.3.a
		ai_chance = {
			factor = 30
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = honest
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.3.a.tooltip # Offering territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}
			set_character_flag = offered_territory_flag
		}
	}
	option = { # Accept it and promise a territory
		name = WtWSMS_foederati.3.b
		ai_chance = {
			factor = 30
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = honest
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.3.b.tooltip # Promising territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
			set_character_flag = promised_territory_to_@event_target:barbarian_negotiator
		}
	}
	option = { # Refuse to grant territory within the empire, offer to settle outside it
		name = WtWSMS_foederati.3.c
		ai_chance = {
			factor = 40
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = deceitful
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.3.c.tooltip # Settle outside counter-offer
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.10 # Makes the offer to settle outside it
			}
		}
		event_target:roman_negotiator = {
			set_character_flag = settling_outside_empire_flag
			set_character_flag = counter_offer
		}
	}
}

# Pick a territory to offer
long_character_event = {
	id = WtWSMS_foederati.4
	desc = WtWSMS_foederati.4.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		if = { # Pick in priority a neighbouring duvhy
			limit = {
				NOT = { has_character_flag = picking_another_offer_territory }
				any_realm_title = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									character = event_target:barbarian_negotiator # Any dejure vassal county of the duchy has a neighbouring county which is held by event_target:barbarian_negotiator
								}
							}
						}
					}
				}
			}
			random_realm_title = {
				limit = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									character = event_target:barbarian_negotiator # Any dejure vassal county of the duchy has a neighbouring county which is held by event_target:barbarian_negotiator
								}
							}
						}
					}
				}
				save_event_target_as = offered_territory
			}
		}
		else_if	= { # Otherwise other duchies can get selected
			limit = {
				any_realm_title = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									AND = { # Any dejure vassal county of the duchy has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator }
										NOT = { same_realm = event_target:roman_negotiator }
									}
								}
							}
						}
					}
				}
			}
			random_realm_title = {
				limit = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									AND = { # Any dejure vassal county of the duchy has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator }
										NOT = { same_realm = event_target:roman_negotiator }
									}
								}
							}
						}
					}
				}
				save_event_target_as = offered_territory
			}
		}
		else = { # No such duchies exists, grants a county instead
			random_realm_title = {
				limit = {
					tier = count
					is_titular = no # Dejure county
					any_direct_de_jure_vassal_title = { # Vassal barony of the county
						is_capital = no # Don't want to hand out the capital county
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									AND = { # Any dejure vassal barony of the county has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator }
										NOT = { same_realm = event_target:roman_negotiator }
									}
								}
							}
						}
					}
				}
				save_event_target_as = offered_territory
			}
		}
	}

	option = { # Pick suggested territory
		name = WtWSMS_foederati.4.a
		trigger = {
			NOT = {
				has_character_flag = enforcing_demands
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.4.a.tooltip # Proposing offered_territory to barbarian_negotiator
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.5 # Makes the offer
				days = 7
				random = 3
			}
		}
		clr_character_flag = picking_another_offer_territory
	}
	option = { # Enforcing demands
		name = WtWSMS_foederati.4.b
		trigger = {
			has_character_flag = enforcing_demands
		}
		custom_tooltip = {
			text = WtWSMS_foederati.4.b.tooltip # Settle barbarian_negotiator in offered_territory
		}
		event_target:barbarian_negotiator = {
			any_realm_province = { # Set flag to give away land
				limit = {
					NOT = { has_province_flag = foederati_give_away }
				}
				set_province_flag = foederati_give_away
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.21 # Victorious Roman enforcing demands upon barbarian
			}
		}
		clr_character_flag = picking_another_offer_territory
	}
	option = { # Find another one than the suggested, reloads same event
		name = WtWSMS_foederati.4.c
		trigger = {
			ai = no
		}
		custom_tooltip = {
			text = WtWSMS_foederati.4.c.tooltip # Look for another territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}
		}
		clear_event_target = offered_territory
		set_character_flag = picking_another_offer_territory
	}
}

# Makes the offer
long_character_event = {
	id = WtWSMS_foederati.5
	desc = {
		trigger = {
			event_target:roman_negotiator = {
				NOT = { has_character_flag = counter_offer }
			}
		}
		text = WtWSMS_foederati.5.desc.a
	}
	desc = {
		trigger = {
			event_target:roman_negotiator = {
				has_character_flag = counter_offer
			}
		}
		text = WtWSMS_foederati.5.desc.b
	}
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Accept the offer
		name = WtWSMS_foederati.5.a
		ai_chance = {
			factor = 75
		}
		custom_tooltip = {
			text = WtWSMS_foederati.5.a.tooltip # Negotiations successful
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
			any_realm_province = { # Set flag to give away land
				limit = {
					NOT = { has_province_flag = foederati_give_away }
				}
				set_province_flag = foederati_give_away
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
	}
	option = { # Refuse the offer
		name = WtWSMS_foederati.5.b
		ai_chance = {
			# More likely to refuse if counter-offer
			factor = 25
			modifier = {
				factor = 2
				event_target:roman_negotiator = {
					has_character_flag = counter_offer
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.5.b.tooltip # Offer refused
		}
		clear_event_target = offered_territory
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.6 # Barbarian refuses province offer
				days = 7
				random = 3
			}
		}
	}
}

# Barbarian refuses province offer
long_character_event = {
	id = WtWSMS_foederati.6
	desc = WtWSMS_foederati.6.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Pick another territory to offer
		name = WtWSMS_foederati.6.a
		ai_chance = {
			factor = 25
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = patient
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.6.a.tooltip # Offer another territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}
			set_character_flag = picking_another_offer_territory
		}
	}
	option = {	# Break negotiations
		name = WtWSMS_foederati.6.b
		ai_chance = {
			factor = 75
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = proud
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.6.b.tooltip # Negotiations break
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
	}
}

# Pick a territory to promise
long_character_event = {
	id = WtWSMS_foederati.7
	desc = WtWSMS_foederati.7.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		if = { # Pick in priority a neighbouring duvhy
			limit = {
				NOT = { has_character_flag = picking_another_promise_territory }
				any_realm_title = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									character = event_target:barbarian_negotiator # Any dejure vassal county of the duchy has a neighbouring county which is held by event_target:barbarian_negotiator
								}
							}
						}
					}
				}
			}
			random_realm_title = {
				limit = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									character = event_target:barbarian_negotiator # Any dejure vassal county of the duchy has a neighbouring county which is held by event_target:barbarian_negotiator
								}
							}
						}
					}
				}
				save_event_target_as = promised_territory
			}
		}
		else_if	= { # Otherwise other duchies can get selected
			limit = {
				any_realm_title = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									AND = { # Any dejure vassal county of the duchy has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator }
										NOT = { same_realm = event_target:roman_negotiator }
									}
								}
							}
						}
					}
				}
			}
			random_realm_title = {
				limit = {
					tier = duke
					is_titular = no # Dejure duchy
					any_direct_de_jure_vassal_title = { # Vassal county of the duchy
						is_capital = no # Don't want to hand out the capital duchy
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									AND = { # Any dejure vassal county of the duchy has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator }
										NOT = { same_realm = event_target:roman_negotiator }
									}
								}
							}
						}
					}
				}
				save_event_target_as = promised_territory
			}
		}
		else = { # No such duchies exists, grants a county instead
			random_realm_title = {
				limit = {
					tier = count
					is_titular = no # Dejure county
					any_direct_de_jure_vassal_title = { # Vassal barony of the county
						is_capital = no # Don't want to hand out the capital county
						de_jure_liege = PREV
						location = {
							any_neighbor_province = {
								holder_scope = {
									AND = { # Any dejure vassal barony of the county has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator }
										NOT = { same_realm = event_target:roman_negotiator }
									}
								}
							}
						}
					}
				}
				save_event_target_as = promised_territory
			}
		}
	}

	option = { # Pick suggested territory
		name = WtWSMS_foederati.7.a
		custom_tooltip = {
			text = WtWSMS_foederati.7.a.tooltip # Promising promised_territory to barbarian_negotiator
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.8 # Makes the promise
				days = 7
				random = 3
			}
		}
		clr_character_flag = picking_another_promise_territory
	}
	option = { # Find another one than the suggested, reloads same event
		name = WtWSMS_foederati.7.b
		trigger = {
			ai = no
		}
		custom_tooltip = {
			text = WtWSMS_foederati.7.b.tooltip # Look for another territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
		}
		clear_event_target = promised_territory
		set_character_flag = picking_another_promise_territory
	}
}

# Makes the promise
long_character_event = {
	id = WtWSMS_foederati.8
	desc = {
		trigger = {
			event_target:roman_negotiator = {
				NOT = { has_character_flag = counter_offer }
			}
		}
		text = WtWSMS_foederati.8.desc.a
	}
	desc = {
		trigger = {
			event_target:roman_negotiator = {
				has_character_flag = counter_offer
			}
		}
		text = WtWSMS_foederati.8.desc.b
	}
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Accept the promise
		name = WtWSMS_foederati.8.a
		ai_chance = {
			factor = 60
		}
		custom_tooltip = {
			text = WtWSMS_foederati.8.a.tooltip # Negotiations successful
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
			any_realm_province = { # Set flag to give away land
				limit = {
					NOT = { has_province_flag = foederati_give_away }
				}
				set_province_flag = foederati_give_away
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
	}
	option = { # Refuse the promise
		name = WtWSMS_foederati.8.b
		ai_chance = {
			factor = 40
			# More likely to refuse if counter-offer
			modifier = {
				factor = 2
				event_target:roman_negotiator = {
					has_character_flag = counter_offer
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.5.b.tooltip # Offer refused
		}
		clear_event_target = promised_territory
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.9 # Barbarian refuses province promise
				days = 7
				random = 3
			}
		}
	}
}

# Barbarian refuses province promise
long_character_event = {
	id = WtWSMS_foederati.9
	desc = WtWSMS_foederati.9.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Pick another territory to promise
		name = WtWSMS_foederati.9.a
		ai_chance = {
			factor = 25
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = patient
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.9.a.tooltip # Promise another territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
			set_character_flag = picking_another_promise_territory
		}
	}
	option = {	# Break negotiations
		name = WtWSMS_foederati.9.b
		ai_chance = {
			factor = 75
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = proud
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.9.b.tooltip # Negotiations break
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
	}
}
	
# Makes the offer to settle outside it
long_character_event = {
	id = WtWSMS_foederati.10
	desc = WtWSMS_foederati.10.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Barbarian accepts
		name = WtWSMS_foederati.10.a
		ai_chance = {
			factor = 25
			modifier = {
				factor = 1.25
				event_target:barbarian_negotiator = {
					trait = content
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.10.a.tooltip # Negotiations successful
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
	}
	option = { # Barbarian refuses
		name = WtWSMS_foederati.10.b
		ai_chance = {
			factor = 75
			modifier = {
				factor = 1.25
				event_target:barbarian_negotiator = {
					trait = proud
				}
			}
			# More likely to refuse if counter-offer
			modifier = {
				factor = 2
				event_target:roman_negotiator = {
					has_character_flag = counter_offer
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.10.b.tooltip # Negotiations break
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
	}
}
	
# Barbarian negotiator does not wish to settle in the empire
long_character_event = {
	id = WtWSMS_foederati.11
	desc = WtWSMS_foederati.11.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Accept it
		name = WtWSMS_foederati.11.a
		ai_chance = {
			factor = 40
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = content
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.11.a.tooltip # Settle outside
		}
		event_target:roman_negotiator = {
			set_character_flag = settling_outside_empire_flag
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
		}
	}
	option = { # Refuse it, offer a territory to settle within the empire
		name = WtWSMS_foederati.11.b
		ai_chance = {
			factor = 30
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = stubborn
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.11.b.tooltip # Offering territory counter-offer
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}
			set_character_flag = offered_territory_flag
			set_character_flag = counter_offer
		}
	}
	option = { # Refuse it, promise a territory to settle within the empire
		name = WtWSMS_foederati.11.c
		ai_chance = {
			factor = 30
			modifier = {
				factor = 1.25
				event_target:roman_negotiator = {
					trait = stubborn
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.11.c.tooltip # Promising territory counter-offer
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
			set_character_flag = promised_territory_to_@event_target:barbarian_negotiator
			set_character_flag = counter_offer
		}
	}
}

# Negotiations break
long_character_event = {
	id = WtWSMS_foederati.12
	desc = WtWSMS_foederati.12.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		event_target:roman_negotiator = {
			opinion = {
				modifier = opinion_broken_foederati_negotiations
				who = event_target:barbarian_negotiator
			}
			clr_character_flag = roman_initiated_negotiations
			clr_character_flag = counter_offer
		}
		event_target:barbarian_negotiator = {
			opinion = {
				modifier = opinion_broken_foederati_negotiations
				who = event_target:roman_negotiator
			}
		}
		if = {
			limit = {
				has_character_flag = offered_territory_flag
			}
			clr_character_flag = offered_territory_flag
		}
		if = {
			limit = {
				has_character_flag = promised_territory_to_@event_target:barbarian_negotiator
			}
			clr_character_flag = promised_territory_to_@event_target:barbarian_negotiator
		}
		if = {
			limit = {
				has_character_flag = settling_outside_empire_flag
			}
			clr_character_flag = settling_outside_empire_flag
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati Negotiations between [barbarian_negotiator.GetTitledName] and [roman_negotiator.GetTitledName] broke."
	}

	option = { # OK
		name = WtWSMS_foederati.12.a
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				war = yes
			}
		}
		prestige = -50
	}
	option = { # Romans declare war upon Barbarians impose their demands after failed negotiations
		name = WtWSMS_foederati.12.b
		trigger = {
			OR = { # Is Roman
				has_romance_culture_trigger = yes
				has_landed_title = e_wre
				has_landed_title = e_byzantium
				has_landed_title = e_roman_empire
			}
			NOT = { # Avoid edge case with Ostrogoths
				AND = {
					event_target:barbarian_negotiator = {
						has_landed_title = k_ostrogoths
					}
					has_landed_title = k_ostrogoths
				}
			}
			NOT = { war_with = event_target:barbarian_negotiator }
			event_target:barbarian_negotiator = { # Character needs land for the war to be valid
				is_landed = yes
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				event_target:barbarian_negotiator = {
					event_target:roman_negotiator = {
						relative_power = {
							who = PREV
							power = 2
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.12.b.tooltip # War
		}
		unsafe_war = { # always = no CB
			target = event_target:barbarian_negotiator
			casus_belli = tributary_foederati_cb
			infamy = 0
		}
		event_target:roman_negotiator = {
			set_character_flag = declared_tributary_foederati_cb_war_on_@event_target:barbarian_negotiator
		}
	}
	option = { # Barbarians declare war upon Romans to impose their demands after failed negotiations
		name = WtWSMS_foederati.12.c
		trigger = {
			foederati_barbarian_trigger = yes # Is Barbarian
			NOT = { # Avoid edge case with Ostrogoths
				AND = {
					event_target:roman_negotiator = {
						has_landed_title = k_ostrogoths
					}
					has_landed_title = k_ostrogoths
				}
			}
			NOT = { war_with = event_target:roman_negotiator }
			event_target:roman_negotiator = { # Character needs land for the war to be valid
				is_landed = yes
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				event_target:roman_negotiator = {
					event_target:barbarian_negotiator = {
						relative_power = {
							who = PREV
							power = 2
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.12.c.tooltip # War
		}
		if = {
			limit = {
				AND = {
					NOT = { year = 800 } # The migration period ended around 800
					event_target:barbarian_negotiator = {
						OR = {
							religion = tengri_pagan
							religion = slavic_pagan
							religion = germanic_pagan
							culture = alan
						}
						NOT = { has_character_modifier = launched_migration_war }
						NOT = { higher_tier_than = KING } # No Emperors
						NOT = { culture = FROM }
						independent = yes # No vassals
						war = no # Ensures that the events activate correctly
					}
					event_target:roman_negotiator = {
						independent = yes
						war = no
					}
				}
			}
			war = {
				target = event_target:roman_negotiator
				casus_belli = migration
				infamy = 0
			}
		}
		else = {
			event_target:roman_negotiator = {
				random_realm_province = {
					limit = {
						any_neighbor_province = {
							OR = {
								owner = { character = event_target:barbarian_negotiator }
								owner = { top_liege = { character = event_target:barbarian_negotiator } }
							}
						}
					}
					duchy = {
						dejure_liege_title = { #dejure kingdom
							save_event_target_as = tribal_invasion_target
						}
					}
				}
			}
			unsafe_war = {
				target = event_target:roman_negotiator
				casus_belli = tribal_invasion
				thirdparty_title = event_target:tribal_invasion_target
				infamy = 0
			}
		}
	}
}

# Negotiations successful, with both parties having accepted
long_character_event = {
	id = WtWSMS_foederati.13
	desc = WtWSMS_foederati.13.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		event_target:roman_negotiator = {
			opinion = {
				modifier = opinion_successful_foederati_negotiations
				who = event_target:barbarian_negotiator
			}
		}
		event_target:barbarian_negotiator = {
			opinion = {
				modifier = opinion_successful_foederati_negotiations
				who = event_target:roman_negotiator
			}
		}
	}

	option = { # Excellent!
		name = WtWSMS_foederati.13.a
		prestige = 50
		if = {
			limit = {
				OR = { # Is Roman
					has_romance_culture_trigger = yes
					has_landed_title = e_wre
					has_landed_title = e_byzantium
					has_landed_title = e_roman_empire
				}
				NOT = { # Avoid edge case with Ostrogoths
					AND = {
						event_target:barbarian_negotiator = {
							has_landed_title = k_ostrogoths
						}
						has_landed_title = k_ostrogoths
					}
				}
			}
			event_target:roman_negotiator = {
				long_character_event = {
					id = WtWSMS_foederati.14 # Becomes foederati after sucessful negotiations and gets land
				}
			}
		}
	}
}

# Becomes foederati after successful negotiations and gets land
long_character_event = {
	id = WtWSMS_foederati.14
	desc = WtWSMS_foederati.14.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		event_target:roman_negotiator = {
			make_tributary = {
				who = event_target:barbarian_negotiator
				tributary_type = foederati
			}
			event_target:barbarian_negotiator = {
				sound_effect = china_grace_gain
			}
			clr_character_flag = roman_initiated_negotiations
			clr_character_flag = counter_offer
		}
	}

	option = { # Welcome!
		name = WtWSMS_foederati.14.a
		trigger = {
			has_character_flag = offered_territory_flag
		}
		custom_tooltip = {
			text = WtWSMS_foederati.14.a.tooltip # Grant land
		}
		event_target:barbarian_negotiator = {
			primary_title = {
				save_event_target_as = old_primary_title
			}
			any_realm_province = { # Give away old lands
				limit = {
					has_province_flag = foederati_give_away
				}
				county = {
					create_character = {
						random_traits = yes
						dynasty = none
						religion = PREV
						culture = PREV
						female = no
						age = 25
						trait = peasant_leader
					}
					new_character = {
						usurp_title_plus_barony_if_unlanded = PREV
						set_defacto_liege = THIS
						set_truce = {
							who = event_target:barbarian_negotiator
							years = 10
						}
						event_target:barbarian_negotiator = {
							set_truce = {
								who = PREV
								years = 10
							}
						}
					}
				}
				clr_province_flag = foederati_give_away
			}
			# Grant offered land
			if = { # Grant offered duchy
				limit = {
					event_target:offered_territory = {
						tier = DUKE
					}
				}
				event_target:offered_territory = {
					any_de_jure_vassal_title = { # Vassal county of the duchy
						limit = {
							tier = COUNT
						}
						grant_title	= event_target:barbarian_negotiator
					}
				}
			}
			else = { # Grant offered county
				event_target:offered_territory = {
					grant_title	= event_target:barbarian_negotiator
				}
			}
			any_demesne_title = {
				limit = {
					OR = {
						tier = DUKE
						tier = KING
					}
				}
				destroy_landed_title = THIS
			}
			create_title = { # Create new titular duchy
				tier = DUKE
				landless = no
				temporary = no
				custom_created = yes
				culture = event_target:barbarian_negotiator
				holder = event_target:barbarian_negotiator
				name = "FOEDERATI_DUCHY"
				base_title = event_target:old_primary_title
				copy_title_laws = yes
			}
			clear_event_target = old_primary_title
			event_target:offered_territory = {
				destroy_landed_title = THIS
			}
			set_defacto_liege = THIS # Becomes independent
			if = { # Change government from tribal to feudal
				limit = {
					is_tribal = yes
				}
				set_government_type	= feudal_government
			}
			clear_event_target = offered_territory
		}
		event_target:roman_negotiator = {
			clr_character_flag = offered_territory_flag
			make_tributary = {
				who = event_target:barbarian_negotiator
				tributary_type = foederati
			}
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati [barbarian_negotiator.GetTitledName] became a tributary of [roman_negotiator.GetTitledName] and was granted territory."
	}
	option = { # All in due time...
		name = WtWSMS_foederati.14.b
		trigger = {
			has_character_flag = promised_territory_to_@event_target:barbarian_negotiator
		}
		custom_tooltip = {
			text = WtWSMS_foederati.14.b.tooltip # Promised land
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.15 # Barbarian reminded of promise
				days = 1825 # Five years
			}
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati [barbarian_negotiator.GetTitledName] became a tributary of [roman_negotiator.GetTitledName] and was promised territory."
	}
	option = { # Protect the border
		name = WtWSMS_foederati.14.c
		trigger = {
			has_character_flag = settling_outside_empire_flag
		}
		custom_tooltip = {
			text = WtWSMS_foederati.14.c.tooltip # Outside empire
		}
		event_target:roman_negotiator = {
			clr_character_flag = settling_outside_empire_flag
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati [barbarian_negotiator.GetTitledName] became a tributary of [roman_negotiator.GetTitledName] and will protect the border."
	}
}

# Barbarian reminded of promise
long_character_event = {
	id = WtWSMS_foederati.15
	desc = WtWSMS_foederati.15.desc
	picture = GFX_evt_emissary

	is_triggered_only = yes
	
	option = { # Ask for promised territory
		name = WtWSMS_foederati.15.a
		custom_tooltip = {
			text = WtWSMS_foederati.15.a.tooltip # Remind Roman
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.16 # Barbarian reminds Roman of promise
				days = 7
				random = 3
			}
		}
	}
	option = { # Wait more without asking, reloads same event after five years
		name = WtWSMS_foederati.15.b
		trigger = {
			ai = no # Too easy otherwise to trick AI
		}
		custom_tooltip = {
			text = WtWSMS_foederati.15.b.tooltip # Wait and see
		}
		prestige = -50
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.15 # Barbarian reminded of promise
				days = 1825 # Five years
			}
		}
	}
}

# Barbarian reminds Roman of promise
long_character_event = {
	id = WtWSMS_foederati.16
	desc = WtWSMS_foederati.16.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Grant promised territory
		name = WtWSMS_foederati.16.a
		trigger = {
			is_landed = yes
		}
		ai_chance = {
			factor = 25
			modifier = {
				factor = 1.25
				trait = honest
			}
			modifier = {
				factor = 1.25
				trait = content
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.16.a.tooltip # Grant land
		}
		event_target:barbarian_negotiator = {
			primary_title = {
				save_event_target_as = old_primary_title
			}
			any_realm_province = { # Give away old lands
				limit = {
					has_province_flag = foederati_give_away
				}
				county = {
					create_character = {
						random_traits = yes
						dynasty = none
						religion = PREV
						culture = PREV
						female = no
						age = 25
						trait = peasant_leader
					}
					new_character = {
						usurp_title_plus_barony_if_unlanded = PREV
						set_defacto_liege = THIS
						set_truce = {
							who = event_target:barbarian_negotiator
							years = 10
						}
						event_target:barbarian_negotiator = {
							set_truce = {
								who = PREV
								years = 10
							}
						}
					}
				}
				clr_province_flag = foederati_give_away
			}
			# Grant promised land
			if = { # Grant promised duchy
				limit = {
					event_target:promised_territory = {
						tier = DUKE
					}
				}
				event_target:promised_territory = {
					any_de_jure_vassal_title = { # Vassal county of the duchy
						limit = {
							tier = COUNT
						}
						grant_title	= event_target:barbarian_negotiator
					}
				}
			}
			else = { # Grant promised county
				event_target:promised_territory = {
					grant_title	= event_target:barbarian_negotiator
				}
			}
			any_demesne_title = {
				limit = {
					OR = {
						tier = DUKE
						tier = KING
					}
				}
				destroy_landed_title = THIS
			}
			create_title = { # Create new titular duchy
				tier = DUKE
				landless = no
				temporary = no
				custom_created = yes
				culture = event_target:barbarian_negotiator
				holder = event_target:barbarian_negotiator
				name = "FOEDERATI_DUCHY"
				base_title = event_target:old_primary_title
				copy_title_laws = yes
			}
			clear_event_target = old_primary_title
			event_target:promised_territory = {
				destroy_landed_title = THIS
			}
			set_defacto_liege = THIS # Becomes independent
			if = { # Change government from tribal to feudal
				limit = {
					is_tribal = yes
				}
				set_government_type	= feudal_government
			}
			clear_event_target = promised_territory
		}
		event_target:roman_negotiator = {
			clr_character_flag = promised_territory_to_@event_target:barbarian_negotiator
			make_tributary = {
				who = event_target:barbarian_negotiator
				tributary_type = foederati
			}
		}
		# Log foederati negotiations for troubleshooting
		log = "Foederati [barbarian_negotiator.GetTitledName] became a tributary of [roman_negotiator.GetTitledName] and was granted previously promised territory."
	}
	option = { # Attempt to delay further
		name = WtWSMS_foederati.16.b
		trigger = {
			is_landed = yes
		}
		ai_chance = {
			factor = 25
			modifier = {
				factor = 1.25
				trait = socializer
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.16.b.tooltip # Delay further
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.18 # Postponed territory promise
				days = 7
				random = 3
			}
		}
	}
	option = { # Break promise
		name = WtWSMS_foederati.16.c
		trigger = {
			is_landed = yes
		}
		ai_chance = {
			factor = 25
			modifier = {
				factor = 1.25
				trait = deceitful
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.16.c.tooltip # Break pledge
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.17 # Broken territory promise
				days = 7
				random = 3
			}
			clear_event_target = promised_territory
		}
		event_target:roman_negotiator = {
			clr_character_flag = promised_territory_to_@event_target:barbarian_negotiator
		}
	}
	option = { # War to impose concessions
		name = WtWSMS_foederati.16.d
		trigger = {
			event_target:barbarian_negotiator = { # Character needs land for the war to be valid
				is_landed = yes
			}
			is_landed = yes
		}
		ai_chance = {
			factor = 25
			modifier = {
				factor = 1.25
				trait = brave
			}
			modifier = {
				factor = 1.25
				trait = wroth
			}
			modifier = {
				factor = 2
				war = no
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.16.d.tooltip # War
		}
		unsafe_war = { # always = no CB
			target = event_target:barbarian_negotiator
			casus_belli = tributary_foederati_cb
			infamy = 0
		}
		event_target:roman_negotiator = {
			set_character_flag = declared_tributary_foederati_cb_war_on_@event_target:barbarian_negotiator
			remove_tributary = event_target:barbarian_negotiator
		}
	}
	option = { # Unlanded
		name = WtWSMS_foederati.16.e
		trigger = {
			is_landed = no
		}
	}
}

# Broken territory promise
long_character_event = {
	id = WtWSMS_foederati.17
	desc = WtWSMS_foederati.17.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Then war it is
		name = WtWSMS_foederati.17.a
		custom_tooltip = {
			text = WtWSMS_foederati.17.a.tooltip # War
		}
		if = {
			limit = {
				AND = {
					NOT = { year = 800 } # The migration period ended around 800
					event_target:barbarian_negotiator = {
						OR = {
							religion = tengri_pagan
							religion = slavic_pagan
							religion = germanic_pagan
							culture = alan
						}
						NOT = { has_character_modifier = launched_migration_war }
						NOT = { higher_tier_than = KING } # No Emperors
						NOT = { culture = FROM }
						independent = yes # No vassals
						war = no # Ensures that the events activate correctly
					}
					event_target:roman_negotiator = {
						independent = yes
						war = no
					}
				}
			}
			war = {
				target = event_target:roman_negotiator
				casus_belli = migration
				infamy = 0
			}
		}
		else = {
			event_target:roman_negotiator = {
				random_realm_province = {
					limit = {
						any_neighbor_province = {
							OR = {
								owner = { character = event_target:barbarian_negotiator }
								owner = { top_liege = { character = event_target:barbarian_negotiator } }
							}
						}
					}
					duchy = {
						dejure_liege_title = { #dejure kingdom
							save_event_target_as = tribal_invasion_target
						}
					}
				}
			}
			unsafe_war = {
				target = event_target:roman_negotiator
				casus_belli = tribal_invasion
				thirdparty_title = event_target:tribal_invasion_target
				infamy = 0
			}
		}
		event_target:roman_negotiator = {
			remove_tributary = event_target:barbarian_negotiator
		}
	}
}

# Postponed territory promise
long_character_event = {
	id = WtWSMS_foederati.18
	desc = WtWSMS_foederati.18.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Then war it is
		name = WtWSMS_foederati.18.a
		ai_chance = {
			factor = 45
			modifier = {
				factor = 1.25
				trait = wroth
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.18.a.tooltip # War
		}
		if = {
			limit = {
				AND = {
					NOT = { year = 800 } # The migration period ended around 800
					event_target:barbarian_negotiator = {
						OR = {
							religion = tengri_pagan
							religion = slavic_pagan
							religion = germanic_pagan
							culture = alan
						}
						NOT = { has_character_modifier = launched_migration_war }
						NOT = { higher_tier_than = KING } # No Emperors
						NOT = { culture = FROM }
						independent = yes # No vassals
						war = no # Ensures that the events activate correctly
					}
					event_target:roman_negotiator = {
						independent = yes
						war = no
					}
				}
			}
			war = {
				target = event_target:roman_negotiator
				casus_belli = migration
				infamy = 0
			}
		}
		else = {
			event_target:roman_negotiator = {
				random_realm_province = {
					limit = {
						any_neighbor_province = {
							OR = {
								owner = { character = event_target:barbarian_negotiator }
								owner = { top_liege = { character = event_target:barbarian_negotiator } }
							}
						}
					}
					duchy = {
						dejure_liege_title = { #dejure kingdom
							save_event_target_as = tribal_invasion_target
						}
					}
				}
			}
			unsafe_war = {
				target = event_target:roman_negotiator
				casus_belli = tribal_invasion
				thirdparty_title = event_target:tribal_invasion_target
				infamy = 0
			}
		}
		event_target:roman_negotiator = {
			remove_tributary = event_target:barbarian_negotiator
		}
	}
	option = { # Wait and see
		name = WtWSMS_foederati.18.b
		ai_chance = {
			factor = 55
			modifier = {
				factor = 1.25
				trait = patient
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.18.b.tooltip # Wait and see
		}
		prestige = -50
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.15 # Barbarian reminded of promise
				days = 1825 # Five years
			}
		}
	}
}

# Barbarian accept or refuse to start negotiating with Roman
long_character_event = {
	id = WtWSMS_foederati.19
	desc = WtWSMS_foederati.19.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		FROMFROM = {
			save_event_target_as = roman_negotiator
			set_character_flag = roman_initiated_negotiations
		}
		ROOT = {
			save_event_target_as = barbarian_negotiator
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati Negotiations between [FromFrom.GetTitledName] and [Root.GetTitledName] started."
	}
	
	option = { # Yes
		name = WtWSMS_foederati.19.a
		ai_chance = {
			factor = 70
			modifier = {
				factor = 2
				trait = grey_eminence
			}
			modifier = {
				factor = 1.5
				trait = roman_nostalgia
			}
			modifier = {
				factor = 0.5
				realm_size > 50
			}
			modifier = {
				factor = 0.25
				realm_size > 100
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.19.a.tooltip # Negotiations begin
		}
		event_target:barbarian_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.2 # Negotiations begin - settle in empire or not?
			}
		}
	}
	option = { # No, negotiations break
		name = WtWSMS_foederati.19.b
		ai_chance = {
			factor = 30
			modifier = {
				factor = 1.25
				trait = proud
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.19.b.tooltip # Negotiations do not start, risk of war
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.12 # Negotiations break
				days = 7
				random = 3
			}
		}
	}
}

# Victorious Roman force barbarians into foederati status after enforcing demands
long_character_event = {
	id = WtWSMS_foederati.20
	desc = WtWSMS_foederati.20.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes # On_actions event
	
	only_playable = yes
	only_independent = yes
	
	trigger = {
		FROM = { # Attacker
			foederati_barbarian_trigger = yes
		}
		ROOT = { # Defender
			foederati_roman_trigger = yes
		}
	}
	
	immediate = {
		FROM = {
			save_event_target_as = barbarian_negotiator
		}
		ROOT = {
			save_event_target_as = roman_negotiator
			set_character_flag = enforcing_demands
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "[Root.GetTitledName] has enforced demands against the agressor [From.GetTitledName] and will be able to impose foederati status."
	}

	option = { # Settle in the empire
		name = WtWSMS_foederati.20.a
		ai_chance = {
			factor = 20
			modifier = {
				factor = 0.5
				event_target:barbarian_negotiator = {
					realm_size < 50
				}
			}
			modifier = {
				factor = 0.5
				event_target:barbarian_negotiator = {
					lower_tier_than = emperor
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.20.a.tooltip # Granting territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.4 # Pick a territory to offer
				days = 1 # Delay for AI calculation
			}
			set_character_flag = offered_territory_flag
		}
	}
	option = { # Settle outside the empire
		name = WtWSMS_foederati.20.b
		ai_chance = {
			factor = 60
		}
		custom_tooltip = {
			text = WtWSMS_foederati.20.b.tooltip # Settle outside
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.21 # Victorious Roman enforcing demands upon barbarian
				days = 1 # Delay for AI calculation
			}
			set_character_flag = settling_outside_empire_flag
		}
	}
	option = { # Let them be for now
		name = WtWSMS_foederati.20.c
		ai_chance = {
			factor = 20
		}
		custom_tooltip = {
			text = WtWSMS_foederati.20.c.tooltip # Nothing happens
		}
		prestige = -50
	}
}

# Victorious Roman enforcing demands upon barbarian
long_character_event = {
	id = WtWSMS_foederati.21
	desc = WtWSMS_foederati.21.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	immediate = {
		event_target:roman_negotiator = {
			make_tributary = {
				who = event_target:barbarian_negotiator
				tributary_type = foederati
			}
			event_target:barbarian_negotiator = {
				sound_effect = china_grace_gain
			}
		}
	}

	option = { # Welcome!
		name = WtWSMS_foederati.21.a
		trigger = {
			has_character_flag = offered_territory_flag
		}
		custom_tooltip = {
			text = WtWSMS_foederati.21.a.tooltip # Grant land
		}
		event_target:barbarian_negotiator = {
			primary_title = {
				save_event_target_as = old_primary_title
			}
			any_realm_province = { # Give away old lands
				limit = {
					has_province_flag = foederati_give_away
				}
				county = {
					create_character = {
						random_traits = yes
						dynasty = none
						religion = PREV
						culture = PREV
						female = no
						age = 25
						trait = peasant_leader
					}
					new_character = {
						usurp_title_plus_barony_if_unlanded = PREV
						set_defacto_liege = THIS
						set_truce = {
							who = event_target:barbarian_negotiator
							years = 10
						}
						event_target:barbarian_negotiator = {
							set_truce = {
								who = PREV
								years = 10
							}
						}
					}
				}
				clr_province_flag = foederati_give_away
			}
			# Grant offered land
			if = { # Grant offered duchy
				limit = {
					event_target:offered_territory = {
						tier = DUKE
					}
				}
				event_target:offered_territory = {
					any_de_jure_vassal_title = { # Vassal county of the duchy
						limit = {
							tier = COUNT
						}
						grant_title	= event_target:barbarian_negotiator
					}
				}
			}
			else = { # Grant offered county
				event_target:offered_territory = {
					grant_title	= event_target:barbarian_negotiator
				}
			}
			any_demesne_title = {
				limit = {
					OR = {
						tier = DUKE
						tier = KING
					}
				}
				destroy_landed_title = THIS
			}
			create_title = { # Create new titular duchy
				tier = DUKE
				landless = no
				temporary = no
				custom_created = yes
				culture = event_target:barbarian_negotiator
				holder = event_target:barbarian_negotiator
				name = "FOEDERATI_DUCHY"
				base_title = event_target:old_primary_title
				copy_title_laws = yes
			}
			clear_event_target = old_primary_title
			event_target:offered_territory = {
				destroy_landed_title = THIS
			}
			set_defacto_liege = THIS # Becomes independent
			if = { # Change government from tribal to feudal
				limit = {
					is_tribal = yes
				}
				set_government_type	= feudal_government
			}
			clear_event_target = offered_territory
		}
		event_target:roman_negotiator = {
			clr_character_flag = offered_territory_flag
			make_tributary = {
				who = event_target:barbarian_negotiator
				tributary_type = foederati
			}
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati [barbarian_negotiator.GetTitledName] became a tributary of [roman_negotiator.GetTitledName] by force and was granted territory."
	}
	option = { # Protect the border
		name = WtWSMS_foederati.21.b
		trigger = {
			has_character_flag = settling_outside_empire_flag
		}
		custom_tooltip = {
			text = WtWSMS_foederati.21.b.tooltip # Outside empire
		}
		event_target:roman_negotiator = {
			clr_character_flag = settling_outside_empire_flag
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "Foederati [barbarian_negotiator.GetTitledName] became a tributary of [roman_negotiator.GetTitledName] by force and will protect the border."
	}
}

# Barbarians can open foederati negotiations with the Romans after white peace (ROOT is Roman)
long_character_event = {
	id = WtWSMS_foederati.22
	
	is_triggered_only = yes # On_actions event
	
	hide_window = yes
	
	only_playable = yes
	only_independent = yes
	
	trigger = {
		FROM = { # Attacker
			foederati_barbarian_trigger = yes
		}
		ROOT = { # Defender
			foederati_roman_trigger = yes
		}
	}
	
	immediate = {
		FROM = {
			save_event_target_as = barbarian_negotiator
			long_character_event = {
				id = WtWSMS_foederati.31
			}
		}
		ROOT = {
			save_event_target_as = roman_negotiator
		}
	}
}

###############################
# Death of foederati
###############################

# Following the death of the foederati ruler, the new one has the choice to leave (ROOT is the dead ruler)
long_character_event = {
	id = WtWSMS_foederati.23
	
	is_triggered_only = yes # On_actions event
	
	hide_window = yes
	
	only_independent = yes
	
	trigger = {
		is_tributary = {
			type = foederati
		}
	}
	
	immediate = {
		current_heir = {
			save_event_target_as = foederati # Used for localisation
			long_character_event = {
				id = WtWSMS_foederati.24
				days = 1
			}
		}
	}
}

# Following the death of the foederati ruler, the new one has the choice to leave (ROOT is the heir of the dead ruler)
long_character_event = {
	id = WtWSMS_foederati.24
	desc = WtWSMS_foederati.24.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes # On_actions event
	
	immediate = {
		suzerain = {
			save_event_target_as = suzerain # Used for localisation
		}
	}

	option = { # Remain foederati
		name = WtWSMS_foederati.24.a
		ai_chance = {
			factor = 50
			modifier = {
				factor = 3
				war = yes
				any_war = { defender = { character = ROOT } }
			}
			modifier = {
				factor = 1.5
				suzerain = {
					any_realm_province = { any_neighbor_province = { owner = { same_realm = ROOT } } }
				}
			}
			modifier = {
				factor = 1.5
				trait = craven
			}
			modifier = {
				factor = 1.5
				trait = content
			}
			modifier = {
				factor = 1.5
				trait = humble
			}
			modifier = {
				factor = 2
				suzerain = {
					OR = {
						dynasty = ROOT
						is_allied_with = ROOT
						is_friend = ROOT
					}
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.24.a.tooltip # Remains foederati
		}
	}
	# Renegotiate option?
	option = { # Leave
		name = WtWSMS_foederati.24.b
		trigger = {
			is_adult = yes
			NOT = { trait = incapable }
			prisoner = no
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				suzerain = {
					any_realm_province = { any_neighbor_province = { owner = { same_realm = ROOT } } }
					realm_levy_diff = { who = ROOT value = 5000 }
				}
			}
			modifier = {
				factor = 2
				suzerain = {
					is_rival = ROOT
				}
			}
			modifier = {
				factor = 1.5
				suzerain = {
					NOT = {
						any_realm_province = { any_neighbor_province = { owner = { same_realm = ROOT } } }
					}
				}
			}
			modifier = {
				factor = 1.5
				trait = brave
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 1.5
				trait = proud
			}
			modifier = {
				factor = 1.5
				suzerain = { reverse_realm_levy_diff = { who = ROOT value = 10000 } }
			}
			modifier = {
				factor = 1.5
				suzerain = { reverse_realm_levy_diff = { who = ROOT value = 7500 } }
			}
			modifier = {
				factor = 1.5
				suzerain = { reverse_realm_levy_diff = { who = ROOT value = 5000 } }
			}
			modifier = {
				factor = 1.25
				suzerain = { reverse_realm_levy_diff = { who = ROOT value = 1000 } }
			}
			modifier = {
				factor = 0.5
				suzerain = { realm_levy_diff = { who = ROOT value = 5000 } }
			}
			modifier = {
				factor = 0.5
				suzerain = { realm_levy_diff = { who = ROOT value = 7500 } }
			}
			modifier = {
				factor = 0.5
				suzerain = { realm_levy_diff = { who = ROOT value = 10000 } }
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.24.b.tooltip # Does not renew contract, risk of war
		}
		suzerain = {
			remove_tributary = PREV
			long_character_event = {
				id = WtWSMS_foederati.25
				days = 7
				random = 3
			}
		}
	}
}

# Foederati decides to not renew the contract
long_character_event = {
	id = WtWSMS_foederati.25
	desc = WtWSMS_foederati.25.desc
	picture = GFX_evt_emissary

	is_triggered_only = yes
	
	option = { # Let them go
		name = WtWSMS_foederati.25.a
		ai_chance = {
			factor = 50
			modifier = {
				factor = 3
				war = yes
			}
			modifier = {
				factor = 2
				NOT = { any_realm_province = { any_neighbor_province = { owner = { same_realm = FROM } } } }
			}
			modifier = {
				factor = 2
				reverse_realm_levy_diff = { who = FROM value = 100 }
			}
			modifier = {
				factor = 2
				reverse_realm_levy_diff = { who = FROM value = 2500 }
			}
			modifier = {
				factor = 1.25
				trait = patient
			}
			modifier = {
				factor = 1.25
				trait = humble
			}
			modifier = {
				factor = 1.25
				trait = content
			}
			modifier = {
				factor = 1.25
				trait = kind
			}
			modifier = {
				factor = 1.25
				trait = craven
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.25.a.tooltip # Lets the foederati leave
		}
		prestige = -100
		opinion = { who = FROM modifier = opinion_outraged years = 10 }
	}
	option = { # Attack them
		name = WtWSMS_foederati.25.b
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.5
				realm_levy_diff = { who = FROM value = 2500 }
			}
			modifier = {
				factor = 1.5
				realm_levy_diff = { who = FROM value = 5000 }
			}
			modifier = {
				factor = 2
				realm_levy_diff = { who = FROM value = 10000 }
			}
			modifier = {
				factor = 0
				reverse_realm_levy_diff = { who = FROM value = 5000 }
			}
			modifier = {
				factor = 1.25
				trait = wroth
			}
			modifier = {
				factor = 1.25
				trait = proud
			}
			modifier = {
				factor = 1.25
				trait = ambitious
			}
			modifier = {
				factor = 0.5
				NOT = { any_realm_province = { any_neighbor_province = { owner = { same_realm = FROM } } } }
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.25.b.tooltip # Declares war
		}
		unsafe_war = { # always = no CB
			target = FROM
			casus_belli = tributary_foederati_cb
		}
		event_target:roman_negotiator = {
			set_character_flag = declared_tributary_foederati_cb_war_on_@event_target:barbarian_negotiator
		}
	}
}

###############################
# Foederati vassalisation
###############################

# Turn foederati into vassal by force diploaction
long_character_event = {
	id = WtWSMS_foederati.26
	desc = WtWSMS_foederati.26.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	immediate = {
		save_event_target_as = foederati # Used for localisation
	}
	
	option = { # Vassalise
		name = WtWSMS_foederati.26.a
		ai_chance = {
			# Rather unlikely
			factor = 20
			modifier = {
				factor = 2
				event_target:barbarian_negotiator = {
					event_target:roman_negotiator = {
						relative_power = {
							who = PREV
							power = 2
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.26.a.tooltip # Becomes vassal
		}
		suzerain = {
			remove_tributary = PREV
			ROOT = {
				set_defacto_liege = PREV
			}
			long_character_event = {
				id = WtWSMS_foederati.27 # Foederati accepts to become vassal
				days = 7
				random = 3
			}
		}
	}
	option = { # Refuse
		name = WtWSMS_foederati.26.b
		ai_chance = {
			factor = 80
			modifier = {
				factor = 1.5
				trait = proud
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.26.b.tooltip # Refuses to become vassal
		}
		suzerain = {
			remove_tributary = PREV
			long_character_event = {
				id = WtWSMS_foederati.28 # Foederati refuses to accept demands
				days = 7
				random = 3
			}
		}
	}
}

# Foederati accepts to become vassal
long_character_event = {
	id = WtWSMS_foederati.27
	desc = WtWSMS_foederati.27.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Excellent!
		name = WtWSMS_foederati.27.a
		prestige = 100
	}
}

# Foederati refuses to accept demands
long_character_event = {
	id = WtWSMS_foederati.28
	desc = WtWSMS_foederati.28.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # War it is
		name = WtWSMS_foederati.28.a
		ai_chance = {
			factor = 90
			modifier = {
				factor = 1.5
				realm_levy_diff = { who = FROM value = 2500 }
			}
			modifier = {
				factor = 1.5
				realm_levy_diff = { who = FROM value = 5000 }
			}
			modifier = {
				factor = 2
				realm_levy_diff = { who = FROM value = 10000 }
			}
			modifier = {
				factor = 0
				reverse_realm_levy_diff = { who = FROM value = 5000 }
			}
			modifier = {
				factor = 1.25
				trait = wroth
			}
			modifier = {
				factor = 1.25
				trait = proud
			}
			modifier = {
				factor = 1.25
				trait = ambitious
			}
			modifier = {
				factor = 0.5
				NOT = { any_realm_province = { any_neighbor_province = { owner = { same_realm = FROM } } } }
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.28.a.tooltip # War
		}
		if = {
			limit = {
				has_dlc = "Jade Dragon"
			}
			unsafe_war = {
				target = FROM
				casus_belli = force_vassalization
			}
		}
		else = {
			unsafe_war = {
				target = FROM
				casus_belli = pagan_subjugation # To test
			}
		}
	}
	option = { # Accept their independence
		name = WtWSMS_foederati.28.b
		ai_chance = {
			factor = 10
			# If foederati is unusually mighty
			modifier = {
				factor = 2
				ROOT = {
					FROM = {
						relative_realm_size = {
							who = PREV
							size = 1
						}
					}
				}
			}
			modifier = {
				factor = 2
				ROOT = {
					FROM = {
						relative_power = {
							who = PREV
							power = 1
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.28.b.tooltip # Accept independence
		}
		prestige = -100
		FROM = {
			long_character_event = {
				id = WtWSMS_foederati.29 # Former suzerain concedes
				days = 7
				random = 3
			}
		}
	}
}

# Former suzerain concedes
long_character_event = {
	id = WtWSMS_foederati.29
	desc = WtWSMS_foederati.29.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes

	option = { # Weaklings!
		name = WtWSMS_foederati.29.a
		prestige = 50
	}
}

###############################
# More foederati negotiations
###############################

# Victorious Roman force barbarians into foederati status after enforcing demands
long_character_event = {
	id = WtWSMS_foederati.30
	desc = WtWSMS_foederati.30.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes # Triggered by tributary_foederati_cb event
	
	only_playable = yes
	only_independent = yes
	
	trigger = {
		ROOT = {
			has_character_flag = declared_tributary_foederati_cb_war_on_@event_target:target_loser # Event target set in CB
		}
	}
	
	immediate = {
		event_target:target_loser = {
			save_event_target_as = barbarian_negotiator
		}
		ROOT = {
			save_event_target_as = roman_negotiator
			set_character_flag = enforcing_demands
			clr_character_flag = declared_tributary_foederati_cb_war_on_@event_target:target_loser
		}
		# Log foederati negotiations to check if ai_will_do is good
		log = "[Root.GetTitledName] has won a war to make [target_loser.GetTitledName] a foederatus and will be able to impose foederati status."
	}

	option = { # Settle in the empire
		name = WtWSMS_foederati.30.a
		ai_chance = {
			factor = 30
		}
		custom_tooltip = {
			text = WtWSMS_foederati.30.a.tooltip # Granting territory
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}
			set_character_flag = offered_territory_flag
		}
	}
	option = { # Settle outside the empire
		name = WtWSMS_foederati.30.b
		ai_chance = {
			factor = 70
		}
		custom_tooltip = {
			text = WtWSMS_foederati.30.b.tooltip # Settle outside
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.21 # Victorious Roman enforcing demands upon barbarian
			}
			set_character_flag = settling_outside_empire_flag
		}
	}
}

# Barbarians can open foederati negotiations with the Romans after white peace (ROOT is Barbarian)
long_character_event = {
	id = WtWSMS_foederati.31
	desc = WtWSMS_foederati.31.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	option = { # Open negotiations
		name = WtWSMS_foederati.31.a
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.5
				event_target:roman_negotiator = {
					trait = strategist
				}
			}
			modifier = {
				factor = 1.5
				event_target:roman_negotiator = {
					trait = trusting
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.31.a.tooltip # Negotiations begin
		}
		event_target:roman_negotiator = {
			long_character_event = {
				id = WtWSMS_foederati.1 # Romans accept or refuse to start negotiating with barbarian
				days = 7
				random = 3
			}
		}
	}
	option = { # Refuse to open negotiations
		name = WtWSMS_foederati.31.b
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.5
				event_target:roman_negotiator = {
					trait = stubborn
				}
			}
			modifier = {
				factor = 1.5
				event_target:roman_negotiator = {
					opinion = { who = event_target:barbarian_negotiator value < -20 }
				}
			}
		}
		custom_tooltip = {
			text = WtWSMS_foederati.31.b.tooltip # Negotiations do not start
		}
	}
}